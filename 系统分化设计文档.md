# 系统分化设计文档（Level-1 DFD / 业务域ER / 时序图）

## 一、数据流分解（Level-1 DFD）

### 1.1 订单处理 1层DFD
```mermaid
graph TB
    User[消费者]
    PayGW[支付网关]
    Emp[门店员工]

    D1[(D1 用户/地址库)]
    D2[(D2 菜品/套餐库)]
    D3[(D3 订单/明细库)]

    P31((3.1 创建订单))
    P32((3.2 支付处理))
    P33((3.3 接单/拒单))
    P34((3.4 派送管理))
    P35((3.5 完成/取消))

    User -->|选择菜品/地址| P31
    P31 -->|校验与定价| D2
    P31 -->|生成订单| D3
    P31 -->|下单反馈| User

    User -->|发起支付| P32
    P32 -->|支付参数| PayGW
    PayGW -->|支付回调| P32
    P32 -->|更新支付状态| D3

    Emp -->|接单/拒单| P33
    P33 -->|状态更新| D3

    Emp -->|派送进度| P34
    P34 -->|派送状态| D3

    User -->|确认收货/取消| P35
    P35 -->|终态更新| D3
```

### 1.2 菜品管理 1层DFD
```mermaid
graph TB
    Emp[门店员工]
    OSS[对象存储]
    D2[(D2 菜品/套餐库)]

    P21((2.1 新增菜品))
    P22((2.2 修改菜品))
    P23((2.3 上下架))
    P24((2.4 口味维护))

    Emp -->|填写基本/口味| P21
    P21 -->|入库菜品| D2
    P21 -->|图片上传| OSS

    Emp -->|编辑信息| P22
    P22 -->|更新菜品| D2

    Emp -->|批量上下架| P23
    P23 -->|状态更新| D2

    Emp -->|增删口味| P24
    P24 -->|口味入库| D2
```

### 1.3 系统管理 1层DFD
```mermaid
graph TB
    Admin[系统管理员]
    DEmp[(员工库)]
    DRole[(角色库)]
    DPerm[(权限库)]
    DRP[(角色权限库)]
    DBranch[(分店库)]
    DLog[(日志库)]

    P41((4.1 员工管理))
    P42((4.2 角色管理))
    P43((4.3 权限分配))
    P44((4.4 分店配置))
    P45((4.5 日志审计))

    Admin -->|新增/修改/锁定| P41
    P41 -->|员工数据| DEmp

    Admin -->|新增/修改角色| P42
    P42 -->|角色数据| DRole

    Admin -->|分配菜单/按钮| P43
    P43 -->|权限数据| DPerm
    P43 -->|写入角色权限| DRP

    Admin -->|分店启停/信息维护| P44
    P44 -->|配置写入| DBranch

    Admin -->|查询/导出| P45
    P45 -->|审计记录| DLog
```

## 二、业务域 ER 子图

### 2.1 账户与权限域
```mermaid
erDiagram
    EMPLOYEE ||--o{ LOGIN_LOG : login
    EMPLOYEE ||--o{ OPERATION_LOG : operate
    ROLE ||--o{ EMPLOYEE : assign
    PERMISSION ||--o{ ROLE_PERMISSION : bind
    ROLE ||--o{ ROLE_PERMISSION : define
    PERMISSION ||--o{ PERMISSION : parent_of

    EMPLOYEE {
        bigint id
        varchar username
        varchar password
        varchar name
        varchar phone
        bigint role_id
        bigint branch_id
        tinyint status
    }
    ROLE {
        bigint id
        varchar name
        varchar description
        tinyint status
    }
    PERMISSION {
        bigint id
        varchar name
        tinyint type
        varchar path
        bigint parent_id
        tinyint status
    }
    ROLE_PERMISSION {
        bigint id
        bigint role_id
        bigint permission_id
    }
    LOGIN_LOG {
        bigint id
        bigint employee_id
        varchar username
        bigint branch_id
        varchar ip
        datetime login_time
        tinyint status
    }
    OPERATION_LOG {
        bigint id
        bigint operator_id
        varchar operator_name
        bigint branch_id
        varchar module
        varchar operation_type
        varchar content
        varchar ip
        datetime operation_time
        tinyint status
    }
```

### 2.2 商品域
```mermaid
erDiagram
    BRANCH ||--o{ CATEGORY : has
    BRANCH ||--o{ DISH : has
    BRANCH ||--o{ SETMEAL : has
    CATEGORY ||--o{ DISH : classify
    CATEGORY ||--o{ SETMEAL : classify
    DISH ||--o{ DISH_FLAVOR : has
    SETMEAL ||--o{ SETMEAL_DISH : compose
    DISH ||--o{ SETMEAL_DISH : included

    BRANCH {
        bigint id
        varchar name
        varchar address
        tinyint status
    }
    CATEGORY {
        bigint id
        varchar name
        tinyint type
        int sort
        tinyint status
        bigint branch_id
    }
    DISH {
        bigint id
        varchar name
        bigint category_id
        decimal price
        json specifications
        varchar image
        varchar description
        tinyint status
        bigint branch_id
    }
    DISH_FLAVOR {
        bigint id
        bigint dish_id
        varchar name
        varchar value
    }
    SETMEAL {
        bigint id
        varchar name
        bigint category_id
        decimal price
        varchar image
        varchar description
        tinyint status
        bigint branch_id
    }
    SETMEAL_DISH {
        bigint id
        bigint setmeal_id
        bigint dish_id
        varchar name
        decimal price
        int copies
        int sort
    }
```

### 2.3 订单域
```mermaid
erDiagram
    BRANCH ||--o{ ORDERS : has
    ORDERS ||--o{ ORDER_DETAIL : contain
    DISH ||--o{ ORDER_DETAIL : refer
    SETMEAL ||--o{ ORDER_DETAIL : refer

    ORDERS {
        bigint id
        varchar number
        tinyint status
        bigint branch_id
        varchar consignee
        varchar phone
        varchar address
        datetime order_time
        datetime checkout_time
        tinyint pay_method
        tinyint pay_status
        decimal amount
        decimal pack_amount
        int tableware_number
        tinyint tableware_status
        varchar remark
    }
    ORDER_DETAIL {
        bigint id
        bigint order_id
        varchar name
        varchar image
        bigint dish_id
        bigint setmeal_id
        varchar dish_flavor
        int number
        decimal amount
        decimal total_amount
    }
```

## 三、关键模块时序图

### 3.1 菜品新增
```mermaid
sequenceDiagram
    autonumber
    actor Emp as 门店员工
    participant Web as 管理端前端
    participant API as 后端API
    participant OSS as 对象存储
    participant DB as 数据库

    Emp->>Web: 打开菜品新增表单
    Web->>API: GET /category/list?type=1
    API->>DB: 查询分类
    API-->>Web: 返回分类列表

    Emp->>Web: 填写表单并上传图片
    Web->>OSS: 上传图片文件
    OSS-->>Web: 返回图片URL
    Web->>API: POST /dish (基础信息+口味+图片URL)
    API->>DB: 事务写入 dish + dish_flavor
    API-->>Web: 返回成功
```

### 3.2 权限分配
```mermaid
sequenceDiagram
    autonumber
    actor Admin as 管理员
    participant Web as 管理端前端
    participant API as 后端API
    participant DB as 数据库

    Admin->>Web: 打开角色权限分配
    Web->>API: GET /permission/tree
    API->>DB: 查询权限树
    API-->>Web: 返回权限树

    Admin->>Web: 勾选菜单/按钮并提交
    Web->>API: POST /role/permissions (roleId, permissionIds)
    API->>DB: 写入 role_permission（去重）
    API-->>Web: 返回成功
```

